# 存储体系 - WEB API

> 存储技术为通信提供状态持久化与跨上下文数据共享能力，通过本地数据缓存、会话状态管理、跨标签页同步等机制，优化通信效率并扩展应用场景（如离线通信）。

| 特性       | Cookie           | localStorage | sessionStorage | IndexedDB      |
| ---------- | ---------------- | ------------ | -------------- | -------------- |
| 容量上限   | 4KB              | 5-10MB       | 5-10MB         | ≥250MB         |
| 生命周期   | 手动设置过期时间 | 永久         | 会话级         | 永久           |
| 服务端交互 | 自动携带         | 无           | 无             | 无             |
| 数据格式   | 字符串           | 字符串       | 字符串         | 结构化对象     |
| 查询能力   | 无               | 键值查询     | 键值查询       | 索引查询       |
| 线程安全   | 是               | 是           | 是             | 是（事务隔离） |
| 适用场景   | 会话管理         | 持久化配置   | 临时会话数据   | 复杂离线应用   |

## Cookie

> 最早期的浏览器存储方案，主要用于维持客户端与服务器的会话状态。通过 HTTP 头部在服务端与浏览器间自动传递，具有严格的同源策略和安全限制。

### 核心特性

1. **容量限制**：4KB/域名
2. **自动携带**：随请求自动发送到服务端
3. **过期控制**：支持设置 `max-age`/`expires`
4. **作用域控制**：Domain/Path 限定访问范围
5. **安全标记**：`Secure`/`HttpOnly`/`SameSite` 属性

### 应用场景

1. 用户身份认证（Session ID）
2. 个性化设置存储（主题/语言）
3. 行为跟踪（广告追踪 Cookie）
4. A/B 测试分组标识
5. CSRF 防御 Token 存储

### 基本用法

```js
// 设置 Cookie
document.cookie = `theme=dark; max-age=${30 * 24 * 3600}; path=/; Secure`

// 读取 Cookie
const cookies = document.cookie.split(';').reduce((acc, str) => {
  const [k, v] = str.split('=')
  acc[k.trim()] = v
  return acc
}, {})

// 服务端设置（Node.js）
res.setHeader('Set-Cookie', [
  'sessionId=abc123; HttpOnly; SameSite=Strict',
  'lang=en; Max-Age=2592000',
])
```

## localStorage

> HTML5 的 Web Storage 方案，提供持久化键值存储。数据永久保存直至显式清除，作用域限定在协议+域名+端口层级。

### 核心特性

1. **大容量**：5-10MB/域名（浏览器差异）
2. **持久存储**：不设过期时间
3. **同步访问**：阻塞式读写操作
4. **事件通知**：`storage` 事件跨窗口同步
5. **纯客户端**：不随请求自动发送

### 应用场景

1. 用户偏好设置（主题/布局）
2. 离线数据缓存
3. 表单草稿保存
4. 静态资源版本标记
5. 页面访问计数统计

### 基本用法

```js
// 数据存储
localStorage.setItem(
  'userSettings',
  JSON.stringify({
    darkMode: true,
    fontSize: 16,
  }),
)

// 数据读取
const settings = JSON.parse(localStorage.getItem('userSettings'))

// 事件监听（跨标签页）
window.addEventListener('storage', (e) => {
  console.log(`${e.key} 值变更:`, e.oldValue, '→', e.newValue)
})
```

### 跨标签页通信

```js
// 修改 localStorage 数据
localStorage.setItem('key', 'value')

window.addEventListener('storage', (event) => {
  if (event.key === 'key') {
    console.log('新数据:', event.newValue)
  }
})
```

## sessionStorage

> 数据仅在会话期间保留。关闭标签页或浏览器后自动清除，适合临时性数据存储。

### 核心特性

1. **会话级存储**：标签页关闭即清除
2. **独立作用域**：同源不同标签页不共享
3. **容量限制**：5-10MB/域名
4. **同步访问**：同 `localStorage`
5. **临时存储**：无持久化需求场景适用

### 应用场景

1. 表单多步骤暂存
2. 单页应用路由状态
3. 敏感信息临时缓存
4. 页面刷新恢复数据
5. 防重复提交令牌存储

### 基本用法

```js
// 保存当前步骤
sessionStorage.setItem('checkoutStep', 'payment')

// 恢复页面状态
window.addEventListener('pageshow', () => {
  const step = sessionStorage.getItem('checkoutStep')
  if (step) navigateToStep(step)
})

// 清除敏感数据
window.addEventListener('beforeunload', () => {
  sessionStorage.removeItem('tempToken')
})
```

## IndexedDB

> 浏览器端的事务型 NoSQL 数据库，支持结构化数据存储、索引查询和异步操作。适合存储大量结构化数据，提供比 Web Storage
> 更强大的查询能力。

### 核心特性

1. **大容量存储**：动态扩展（通常≥250MB）
2. **事务支持**：ACID 特性保障数据完整性
3. **索引查询**：高效检索复杂数据结构
4. **异步 API**：基于 `Promise`/事件回调
5. **类型丰富**：支持存储文件/二进制数据

### 应用场景

1. 离线 Web 应用数据存储
2. 邮件客户端数据管理
3. 媒体资源元数据存储
4. 日志数据批量缓存
5. 复杂数据统计分析

### 基本用法

```js
// 打开数据库
const request = indexedDB.open('myDatabase', 2)

request.onupgradeneeded = (e) => {
  const db = e.target.result
  if (!db.objectStoreNames.contains('books')) {
    const store = db.createObjectStore('books', { keyPath: 'isbn' })
    store.createIndex('by_author', 'author', { unique: false })
  }
}

request.onsuccess = (e) => {
  const db = e.target.result
  const tx = db.transaction('books', 'readwrite')
  const store = tx.objectStore('books')

  // 添加数据
  store.add({
    isbn: '978-3-16-148410-0',
    title: 'Web开发进阶',
    author: 'John Doe',
    price: 49.99,
  })

  // 索引查询
  const index = store.index('by_author')
  const query = index.getAll('John Doe')
  query.onsuccess = () => console.log(query.result)
}
```
